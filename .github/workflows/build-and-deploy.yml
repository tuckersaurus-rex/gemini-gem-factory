name: Build and Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "workflow/*"

# ==================================================
# GLOBAL CONFIGURATION
# ==================================================
env:
  MANIFEST_FILE: "manifest.yaml"
  GDRIVE_ROOT: ${{ secrets.GEMINI_GEM_FOLDER }}

jobs:
  # ==================================================
  # JOB 1: SETUP
  # ==================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      kernel_file: ${{ steps.parse.outputs.kernel_file }}
      know_dir: ${{ steps.parse.outputs.know_dir }}
      ctx_dir: ${{ steps.parse.outputs.ctx_dir }}
      dist_dir: ${{ steps.parse.outputs.dist_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Environment (yq)
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - name: Configuration (Manifest)
        id: parse
        run: |
          # Extract values using yq
          KERNEL=$(yq -r '.sys_kernel' ${{ env.MANIFEST_FILE }})
          KNOW=$(yq -r '.sys_knowledge' ${{ env.MANIFEST_FILE }})
          CTX=$(yq -r '.sys_context' ${{ env.MANIFEST_FILE }})
          DIST=$(yq -r '.sys_dist' ${{ env.MANIFEST_FILE }})

          # Sanitize
          KNOW="${KNOW%/}"
          CTX="${CTX%/}"
          DIST="${DIST%/}"

          # Set Outputs
          echo "kernel_file=$KERNEL" >> $GITHUB_OUTPUT
          echo "know_dir=$KNOW" >> $GITHUB_OUTPUT
          echo "ctx_dir=$CTX" >> $GITHUB_OUTPUT
          echo "dist_dir=$DIST" >> $GITHUB_OUTPUT

  # ==================================================
  # JOB 2: BUILD
  # ==================================================
  build:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Environment (yq)
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - name: Build (Gem Artifacts)
        run: |
          MANIFEST="${{ env.MANIFEST_FILE }}"
          KERNEL="${{ needs.setup.outputs.kernel_file }}"
          DIR_BRAINS="${{ needs.setup.outputs.know_dir }}"
          DIR_CTX="${{ needs.setup.outputs.ctx_dir }}"
          DIR_DIST="${{ needs.setup.outputs.dist_dir }}"

          mkdir -p "$DIR_DIST"
          JOB_HAS_ERRORS=0

          # ==================================================
          # A. GLOBAL BOOTLOADER (Root Level)
          # ==================================================
          if [ -f "$KERNEL" ]; then
            cp "$KERNEL" "$DIR_DIST/system-instructions.md"
            echo "ðŸ“„ Global Bootloader created at: $DIR_DIST/system-instructions.md"
          else
            echo "::warning::Kernel file '$KERNEL' not found."
          fi

          # ==================================================
          # B. ARTIFACT LOOP
          # ==================================================
          count=$(yq -r '.artifacts | length' $MANIFEST)
          echo "Found $count Artifacts."

          for ((i=0; i<count; i++)); do
            NAME=$(yq -r ".artifacts[$i].name" $MANIFEST)
            ID=$(yq -r ".artifacts[$i].id" $MANIFEST)
            VER=$(yq -r ".artifacts[$i].version" $MANIFEST)
            DESC=$(yq -r ".artifacts[$i].description" $MANIFEST)

            echo "--------------------------------------------------"
            echo "ðŸ”¨ Building: $NAME ($ID v$VER)"

            VALID=1
            FILES_TO_ZIP=""

            # 1. Validate Modules
            for file in $(yq -r ".artifacts[$i].modules[]" $MANIFEST); do
              FULL_PATH="$DIR_BRAINS/$file"
              if [ -f "$FULL_PATH" ]; then
                FILES_TO_ZIP="$FILES_TO_ZIP $FULL_PATH"
              else
                echo "::error::[$NAME] Missing module: $FULL_PATH"
                VALID=0
                JOB_HAS_ERRORS=1
              fi
            done

            if [ "$VALID" -eq 1 ]; then
              TARGET_DIR="$DIR_DIST/$ID"
              mkdir -p "$TARGET_DIR"

              # 2. Generate Metadata (info.txt) - OUTSIDE ZIP
              # This is for easy copy-pasting into AI Studio
              INFO_FILE="$TARGET_DIR/info.txt"
              echo "NAME: $NAME" > "$INFO_FILE"
              echo "DESCRIPTION: $DESC" >> "$INFO_FILE"
              echo "VERSION: $VER" >> "$INFO_FILE"

              # 3. Generate History (README.md) - INSIDE ZIP
              # This is for the AI to know its own version.
              README_FILE="$TARGET_DIR/README.md"
              echo "# $NAME" > "$README_FILE"
              echo "" >> "$README_FILE"
              echo "**Version:** $VER" >> "$README_FILE"
              echo "**ID:** $ID" >> "$README_FILE"
              echo "" >> "$README_FILE"
              echo "## Description" >> "$README_FILE"
              echo "$DESC" >> "$README_FILE"

              # Add README to zip list
              FILES_TO_ZIP="$FILES_TO_ZIP $README_FILE"

              # 4. Copy Context Files (Optional)
              for file in $(yq -r ".artifacts[$i].context[]" $MANIFEST 2>/dev/null); do
                if [ ! -z "$file" ] && [ "$file" != "null" ]; then
                  cp "$DIR_CTX/$file" "$TARGET_DIR/"
                  # Note: To include context INSIDE the zip, uncomment the next line:
                  # FILES_TO_ZIP="$FILES_TO_ZIP $DIR_CTX/$file"
                fi
              done

              # 5. Zip It
              ZIP_NAME="$ID-v$VER.zip"
              # -j flattens paths so we don't get 'brains/x.md' in zip
              zip -j "$TARGET_DIR/$ZIP_NAME" $FILES_TO_ZIP

              # Cleanup temporary README
              rm "$README_FILE"

              echo "âœ… Success: $ID"
            else
              echo "::warning::Skipping $ID due to errors."
            fi
          done

          if [ "$JOB_HAS_ERRORS" -ne 0 ]; then
            exit 1
          fi

      - name: Upload (Gem Artifacts)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gem-build-output
          path: ${{ needs.setup.outputs.dist_dir }}

  # ==================================================
  # JOB 3: DEPLOY
  # ==================================================
  deploy:
    needs: [setup, build]
    runs-on: ubuntu-latest
    if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Environment (Rclone - install)
        run: sudo -v ; curl https://rclone.org/install.sh | sudo bash

      - name: Environment (Rclone - config)
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf

      - name: Download (Gem Artifacts)
        uses: actions/download-artifact@v4
        with:
          name: gem-build-output
          path: ${{ needs.setup.outputs.dist_dir }}

      - name: Deploy (Google Drive)
        run: |
          SOURCE="${{ needs.setup.outputs.dist_dir }}"
          TARGET="gdrive:${{ env.GDRIVE_ROOT }}"

          echo "ðŸš€ Deploying from $SOURCE to Google Drive..."
          rclone copy "$SOURCE" "$TARGET" --transfers=8 --verbose

      - name: Cleanup
        if: always()
        run: rm -rf ~/.config/rclone
