name: Build and Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - "main"

env:
  MANIFEST_FILE: "manifest.yaml"
  GDRIVE_ROOT: ${{ secrets.GDRIVE_DIR }}

jobs:
  # ==================================================
  # JOB 1: BUILD (EXECUTE PYTHON BUILDER)
  # ==================================================
  build:
    runs-on: ubuntu-latest
    outputs:
      dist_dir: ${{ steps.parse_config.outputs.dist_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Dependencies
        run: |
          pip install pyyaml
          # We still use yq to read the output path for the CI workflow steps
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - name: Parse Configuration
        id: parse_config
        run: |
          DIST=$(yq -r '.sys_dist' ${{ env.MANIFEST_FILE }})
          # Remove trailing slash
          DIST="${DIST%/}"
          echo "dist_dir=$DIST" >> $GITHUB_OUTPUT
          echo "::notice::Build output directory set to: $DIST"

      # THE CORE BUILD STEP
      # This script reads manifest.yaml, bundles the modules,
      # zips them, and generates the README.md and Context files.
      - name: Execute Build Engine
        run: python builder.py

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gem-release-candidate
          path: ${{ steps.parse_config.outputs.dist_dir }}

  # ==================================================
  # JOB 2: DEPLOY (SYNC TO DRIVE)
  # ==================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: success() && github.ref == 'refs/heads/main'

    steps:
      - name: Environment (Rclone - install)
        run: sudo -v ; curl https://rclone.org/install.sh | sudo bash

      - name: Environment (Rclone - config)
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: gem-release-candidate
          path: ./release_artifacts

      - name: Deploy to Drive (Mirror Sync)
        run: |
          SOURCE="./release_artifacts"
          TARGET="gdrive:${{ env.GDRIVE_ROOT }}"

          echo "ðŸš€ Syncing Production State to Google Drive..."
          echo "   Source: $SOURCE"
          echo "   Target: $TARGET"

          # SYNC COMMAND EXPLAINED:
          # --delete-during: Deletes files in Drive that are NOT in the build (cleans old versions).
          # --create-empty-src-dirs: Ensures folder structure is preserved.
          # No filters are used; we want an exact mirror.

          rclone sync "$SOURCE" "$TARGET" \
            --transfers=8 \
            --verbose \
            --delete-during \
            --create-empty-src-dirs

      - name: Cleanup
        if: always()
        run: rm -rf ~/.config/rclone
