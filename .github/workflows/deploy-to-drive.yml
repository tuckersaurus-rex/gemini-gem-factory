name: Deploy to Google Drive

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - "workflow/ci-build-and-deploy" # Special branch name for testing CI/CD

jobs:
  # ======================================================
  # JOB 1: BUILD (Parse Manifest & Create Zips)
  # ======================================================
  build:
    runs-on: ubuntu-latest
    steps:
      # 1 Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2 Setup Environment (1/1)
      - name: Setup Environment - yq
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      # 3 Load Configuration (1/1)
      - name: Load Configuration - Manifest
        run: |
          # Read the folder name from YAML
          FOLDER=$(yq -r '.artifact_folder' gem-manifest.yaml)
          # Strip trailing slash just in case
          FOLDER="${FOLDER%/}"
          echo "ARTIFACT_FOLDER=$FOLDER" >> $GITHUB_ENV

      # 4 Build (1/1)
      - name: Build - Gem Artifacts
        run: |
          # 1 Read Global Configs
          MANIFEST="gem-manifest.yaml"

          # Read and strip trailing slashes
          BRAINS_RAW=$(yq -r '.brains_folder' $MANIFEST)
          BRAINS_DIR="${BRAINS_RAW%/}"

          CONTEXT_RAW=$(yq -r '.context_folder' $MANIFEST)
          CONTEXT_DIR="${CONTEXT_RAW%/}"

          # Use the Env Var we set in the previous step
          OUT_DIR="${{ env.ARTIFACT_FOLDER }}"
          mkdir -p "$OUT_DIR"

          # Global Job Failure Flag (0 = success, 1 = fail)
          JOB_HAS_ERRORS=0

          # 2 Get Count of Gems
          count=$(yq -r '.gems | length' $MANIFEST)
          echo "Found $count Gems in Manifest."

          # 3 Loop through Gems
          for ((i=0; i<count; i++)); do

            NAME=$(yq -r ".gems[$i].name" $MANIFEST)
            ID=$(yq -r ".gems[$i].id" $MANIFEST)
            VER=$(yq -r ".gems[$i].version" $MANIFEST)

            echo "--------------------------------------------------"
            echo "Building Gem: $NAME (ID: $ID, Version: $VER)"

            # 3a Validate Gem
            GEM_VALID=1

            # Check Brain Files
            files=""
            for file in $(yq -r ".gems[$i].brains[]" $MANIFEST); do
              FULL_PATH="$BRAINS_DIR/$file"
              if [ -f "$FULL_PATH" ]; then
                files="$files $FULL_PATH"
              else
                echo "::error::[Gem: $NAME] Missing brain file: $FULL_PATH"
                GEM_VALID=0
                JOB_HAS_ERRORS=1
              fi
            done

            # Check Context Files
            for file in $(yq -r ".gems[$i].context[]" $MANIFEST 2>/dev/null); do
              if [ ! -z "$file" ]; then
                FULL_PATH="$CONTEXT_DIR/$file"
                if [ ! -f "$FULL_PATH" ]; then
                  echo "::error::[Gem: $NAME] Missing Context file: $FULL_PATH"
                  GEM_VALID=0
                  JOB_HAS_ERRORS=1
                fi
              fi
            done

            # 3b Build Artifacts
            if [ "$GEM_VALID" -eq 1 ]; then

              # All files found. Proceed to Build.
              TARGET="$OUT_DIR/$ID"
              mkdir -p "$TARGET"

              # Zip brains
              ZIP_NAME="$ID-v$VER.zip"
              zip -j "$TARGET/$ZIP_NAME" $files

              # Copy Context
              for file in $(yq -r ".gems[$i].context[]" $MANIFEST 2>/dev/null); do
                if [ ! -z "$file" ]; then
                  cp "$CONTEXT_DIR/$file" "$TARGET/"
                fi
              done

              echo "::notice::[Gem: $NAME] Successfully built."

            else
              # Files missing. Skip build.
              echo "::warning::[Gem: $NAME] Skipped due to missing files."

            fi

          done

          echo "--------------------------------------------------"

          # 4 Finalize
          if [ "$JOB_HAS_ERRORS" -ne 0 ]; then
            echo "::error::Build completed with errors. One or more Gems were skipped."
            exit 1
          else
            echo "::notice::All Gems built successfully."
          fi

      # 5 Upload (1/1)
      - name: Upload - Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gem-releases
          path: ${{ env.ARTIFACT_FOLDER }}

  # ======================================================
  # JOB 2: DEPLOY (Copy to Google Drive)
  # ======================================================
  deploy:
    needs: build # Wait for build job to finish
    runs-on: ubuntu-latest

    # SAFETY: Only run if the build job succeeded completely
    if: success()

    env:
      GDRIVE_FOLDER: ${{ secrets.GEMINI_GEM_FOLDER }} # Google Drive folder path from secrets

    steps:
      # 1. Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2 Setup Environment (1/2)
      - name: Setup Environment - yq
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      # 3 Setup Environment (2/2)
      - name: Setup Environment - Rclone
        run: sudo -v ; curl https://rclone.org/install.sh | sudo bash

      # 4 Load Configuration (1/2)
      - name: Load Configuration - Manifest
        run: |
          # 4a Read the System Kernel from Manifest
          SYSTEM_KERNEL=$(yq -r '.system_kernel' gem-manifest.yaml)
          echo "SYSTEM_KERNEL=$SYSTEM_KERNEL" >> $GITHUB_ENV

          # 4b Read the Brains Folder from Manifest
          BRAINS_FOLDER=$(yq -r '.brains_folder' gem-manifest.yaml)
          echo "BRAINS_FOLDER=$BRAINS_FOLDER" >> $GITHUB_ENV

          # 4c Read the Context Folder from Manifest
          CONTEXT_FOLDER=$(yq -r '.context_folder' gem-manifest.yaml)
          echo "CONTEXT_FOLDER=$CONTEXT_FOLDER" >> $GITHUB_ENV

          # 4d Read the Artifact Folder from Manifest
          ARTIFACT_FOLDER=$(yq -r '.artifact_folder' gem-manifest.yaml)
          echo "ARTIFACT_FOLDER=$ARTIFACT_FOLDER" >> $GITHUB_ENV

      # 5 Load Configuration (2/2)
      - name: Load Configuration - Rclone
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf

      # 6 Download (1/1)
      - name: Download - Artifacts
        uses: actions/download-artifact@v4
        with:
          name: gem-releases
          path: ${{ env.ARTIFACT_FOLDER }}

      # 7 Verification (1/1)
      - name: Verification - Configuration
        run: |
          # Debug Step: Print where we think we are deploying (without revealing the full secret)
          if [ -z "$GDRIVE_FOLDER" ]; then
            echo "::error::GDRIVE_FOLDER is empty! Check your GitHub Secrets!"
            exit 1
          else
            echo "Verification successful. Proceeding..."
          fi

      # 7 Deploy to Drive (1/4)
      - name: Upload to Google Drive - system-kernel
        run: |
          echo "Deploying system-kernel.md to Google Drive..."
          # NOTE: When copying a single file to a folder, point to the folder
          rclone copy "${{ env.SYSTEM_KERNEL }}" "gdrive:$GDRIVE_FOLDER" --verbose

      # 8. Deploy to Drive (2/4)
      - name: Upload to Google Drive - brains
        run: |
          # Copy the 'brains' directory to the specified Google Drive folder'
          echo "Deploying brains to Google Drive..."
          rclone copy "./${{ env.BRAINS_FOLDER }}" "gdrive:$GDRIVE_FOLDER/${{ env.BRAINS_FOLDER }}" \
            --exclude ".gitkeep" \
            --transfers=10 \
            --verbose

      # 9 Deploy to Drive (3/4)
      - name: Upload to Google Drive - context
        run: |
          # Copy the 'context' directory to the specified Google Drive folder'
          echo "Deploying context to Google Drive..."
          rclone copy "./${{ env.CONTEXT_FOLDER }}" "gdrive:$GDRIVE_FOLDER/${{ env.CONTEXT_FOLDER }}" \
            --exclude ".gitkeep" \
            --transfers=10 \
            --verbose

      # 10 Deploy to Drive (4/4)
      - name: Upload to Google Drive - artifacts
        run: |
          # Copy the 'artifact' directory to the specified Google Drive folder'
          echo "Deploying artifacts to Google Drive..."
          rclone copy "./${{ env.ARTIFACT_FOLDER }}" "gdrive:$GDRIVE_FOLDER/${{ env.ARTIFACT_FOLDER }}" \
            --exclude ".gitkeep" \
            --transfers=10 \
            --verbose

      # 11 Cleanup (1/1)
      - name: Remove Rclone Config
        if: always() # Runs even if previous steps fail
        run: rm -rf ~/.config/rclone
