name: CI Quality Gate

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
      - "feature/*"

env:
  MANIFEST_FILE: "manifest.yaml"

jobs:
  # ==================================================
  # JOB 1: SYNTAX CHECK
  # ==================================================
  markdown-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: "**/*.md"

  # ==================================================
  # JOB 2: PROTOCOL ENFORCER
  # ==================================================
  protocol-enforcer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment (yq)
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - name: Validate Filenames
        run: |
          echo "Reading configuration from ${{ env.MANIFEST_FILE }}..."

          # 1. Parse Knowledge Directory
          KNOW_DIR_RAW=$(yq -r '.sys_knowledge' ${{ env.MANIFEST_FILE }})
          KNOW_DIR="${KNOW_DIR_RAW%/}" # Strip trailing slash

          # 2. Define Decimal Patch v3.0 Regex
          # Added 'kernel' to the allow list
          REGEX="^[0-9]{2}-"
          REGEX+="(kernel|core|role|env|skill|fwk|ui|lib|custom|project)"
          REGEX+="-[a-z0-9-]+\.md$"

          echo "üìè Regex Pattern: $REGEX"

          # 3. Execution
          ERROR_COUNT=0

          if [ -d "$KNOW_DIR" ]; then
            cd "$KNOW_DIR"
            if [ -n "$(ls -A . 2>/dev/null)" ]; then
              for file in *.md; do
                if [[ "$file" == ".gitkeep" ]]; then continue; fi

                if [[ ! "$file" =~ $REGEX ]]; then
                  echo "‚ùå VIOLATION: '$file' invalid format."
                  echo "   Allowed Abbrs: kernel, core, role, env, skill, fwk, ui, lib, custom, project"
                  ERROR_COUNT=$((ERROR_COUNT+1))
                else
                  echo "‚úÖ OK: $file"
                fi
              done
            else
               echo "‚ö†Ô∏è Warning: Knowledge directory '$KNOW_DIR' is empty."
            fi
          else
            echo "::error::Knowledge directory '$KNOW_DIR' does not exist!"
            exit 1
          fi

          # 4. Final Report
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "::error::Found $ERROR_COUNT naming violations."
            exit 1
          else
            echo "üéâ Quality Gate Passed."
          fi
